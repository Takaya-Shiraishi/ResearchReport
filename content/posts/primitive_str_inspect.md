---
title: "Primitive_str_inspect"
date: 2023-07-03T10:03:15+09:00
draft: true
---

# 勝率80%のトレード手法の再検証
実は過去にバックテストの結果として勝率80%前後がコンスタントに出るアルゴリズムを見つけていた。
しかしそのアルゴリズムはコーディングの8割以上をChatGPTに任せたので、本当に自分が指示したようなアルゴリズムの動きをしているのか不安だった。
実際今週かけて検証した所、思った通りのアルゴリズムになっていないことが分かった。
そこで逆にChatGPTが考えたコードを検証してどんなアルゴリズムを書いたのか調査することにした。

## ChatGPTのコードを検証する
```python
def trade_signal(d_df, h4_df, h1_df, m5_df):
    trade_entry = None
    trade_direction = None

    # Check if daily, 4-hour, and 1-hour candles are all bullish or bearish
    if d_df.iloc[-1]['close'] > d_df.iloc[-1]['open'] and h4_df.iloc[-1]['close'] > h4_df.iloc[-1]['open'] and h1_df.iloc[-1]['close'] > h1_df.iloc[-1]['open']:
        trade_direction = "buy"
    elif d_df.iloc[-1]['close'] < d_df.iloc[-1]['open'] and h4_df.iloc[-1]['close'] < h4_df.iloc[-1]['open'] and h1_df.iloc[-1]['close'] < h1_df.iloc[-1]['open']:
        trade_direction = "sell"

    # Calculate 5-minute moving average
    m5_df['MA'] = m5_df['close'].rolling(window=5).mean()

    # Entry signal
    if trade_direction:
        for i in range(len(m5_df) - 1, 4, -1):
            if trade_direction == "buy" and m5_df.iloc[i]['MA'] < m5_df.iloc[i-1]['MA'] and m5_df.iloc[i-1]['MA'] > m5_df.iloc[i-2]['MA']:
                trade_entry = "long"
                break
            elif trade_direction == "sell" and m5_df.iloc[i]['MA'] > m5_df.iloc[i-1]['MA'] and m5_df.iloc[i-1]['MA'] < m5_df.iloc[i-2]['MA']:
                trade_entry = "short"
                break

    return trade_entry, trade_direction
```
ChatGPTの説明は以下。
> このトレーディングアルゴリズムは、4つの異なる時間枠、すなわち1日、4時間、1時間、5分を利用している。このアルゴリズムの全体的な戦略は、大きな時間枠を用いて相場の全体的な方向性を判断し、小さな時間枠を用いて具体的な取引のタイミング（エントリーとエグジット）を決定するというものである。
> 具体的な手順は以下の通りである。
> 1. 全体的な相場の方向性の判断： まず1日、4時間、1時間という大きな時間枠の各最新キャンドルを確認する。全ての時間枠で最新のキャンドルが陽線（終値が始値より高い場合）であれば、市場は上昇トレンドにあると判断し、「買い（buy）」を選択する。一方、全てのキャンドルが陰線（終値が始値より低い場合）であれば、市場は下降トレンドにあると判断し、「売り（sell）」を選択する。
> 2. エントリーポイント（取引開始点）の特定： 次に、5分足の移動平均（過去5本のキャンドルの終値の平均）を利用する。市場の方向性が「買い」である場合、5分足の移動平均が先に下降していたが次に上昇した地点をロング（買い）のエントリーポイントとする。市場の方向性が「売り」である場合、5分足の移動平均が先に上昇していたが次に下降した地点をショート（売り）のエントリーポイントとする。
> 3. エグジットポイント（取引終了点）の特定： ポジションを持っている期間中、5分足の移動平均がトレード方向と逆に転換した地点でポジションを閉じる。すなわち、「買い」の場合は移動平均が下降した時、「売り」の場合は移動平均が上昇した時にポジションをクローズする。

前半は私の想定するコードと同じだったが、後半は５分足の移動平均線を使っていた（私が指定したのは５分足の平均足だった）。
これは、ChatGPTが平均足という指標を知らなかったため、移動平均線を使ったのだと思われる。


## 勝率が高い理由
ChatGPTが考えたコードでは、原始的なチャートパターンとシステムトレードに最適化するための移動平均による平滑化処理を組み合わせ、極めて平易なアルゴリズムでありながらも高い勝率を実現している。
さらに、私は今まで平均足を前提にアルゴリズムを考案してきたがトレンドの流れを捉えるには上位足の標準の足を見たほうがより正確にトレードタイミングを掴めることがわかった。

## 考察
どこで標準のデータを参照し、どこで平滑化処理をするかが高勝率のシステムトレードを実現するための鍵であると考えられる。また、ChatGPTが考案したコードでは５分足の５移動平均線を１５分足でのトレードと捉えることもできるため、最低でも１５分足以上の時間足では移動平均によって相場のノイズを相殺できると考えられる。そしてなにより、上位足でのトレード判断を下位足でのトレードに活かす事でより多くのpipsを獲得できると考えられる。